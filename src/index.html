<html>
<head>
<script>
const PIXI = require('pixi.js');
</script>
<meta charset="UTF-8">
<title>タイトル</title>
</head>
<body>
<h1>Sample</h1>
<script>

var testdata = [
{dt:new Date(),open:139.63,end:139.63,high:139.75,low:139.63}
,{dt:new Date(),open:139.63,end:139.63,high:139.75,low:139.63}
,{dt:new Date(),open:139.63,end:139.53,high:140.05,low:139.43}
,{dt:new Date(),open:139.53,end:140.09,high:140.13,low:139.53}
,{dt:new Date(),open:140.11,end:140.41,high:140.5,low:140.09}
,{dt:new Date(),open:140.41,end:140.23,high:140.46,low:140.19}
,{dt:new Date(),open:140.23,end:140.32,high:140.42,low:140.18}
,{dt:new Date(),open:140.33,end:140.28,high:140.43,low:140.2}
,{dt:new Date(),open:140.28,end:140.18,high:140.32,low:140.17}
,{dt:new Date(),open:140.16,end:140.24,high:140.31,low:140.08}
,{dt:new Date(),open:140.25,end:140.28,high:140.44,low:140.15}
,{dt:new Date(),open:140.29,end:140.29,high:140.42,low:140.24}
,{dt:new Date(),open:140.25,end:140.23,high:140.4,low:140.18}
,{dt:new Date(),open:140.21,end:140.25,high:140.38,low:140.19}
,{dt:new Date(),open:140.28,end:140.18,high:140.35,low:140.17}
,{dt:new Date(),open:140.18,end:140.31,high:140.37,low:140.16}
,{dt:new Date(),open:140.34,end:140.2,high:140.37,low:140.17}
,{dt:new Date(),open:140.2,end:140.2,high:140.27,low:140.12}
,{dt:new Date(),open:140.21,end:140.18,high:140.34,low:140.14}
];

let app = new PIXI.Application({ 
    width: 256, 
    height: 256,                       
    antialias: true, 
    transparent: false, 
    resolution: 1
  }
);

document.body.appendChild(app.view);

class ChartTick {
  constructor(opt) {
    this.dt    = opt.dt;
    this.open  = opt.open;
    this.end   = opt.end;
    this.high  = opt.high;
    this.low   = opt.low;

    this.x = 0;
    this.y = 0;
    this.width = 1;
    this.height = 1;

    this.sprite = null;

  }

  getSprite() {
    //rectangle.lineStyle(4, 0xFF3300, 1);
    if (this.sprite == null) {
      let g = new PIXI.Graphics();
      g.beginFill(0x66CCFF);
      g.drawRect(0, 0, 1, 1);
      g.endFill();
      this.sprite = new PIXI.Sprite(g.generateTexture());
      this.sprite.x = this.x;
      this.sprite.y = this.y;
    }
    return this.sprite;
  }

  setPosition(args) {
    this.x = args.x;
    this.y = args.y;
    this.width  = args.w;
    this.height = args.h;
    if (!this.sprite) {
      return;
    }
    this.sprite.x = args.x;
    this.sprite.y = args.y;
    this.sprite.width  = args.w;
    this.sprite.height = args.h;
  }
}

class ChartContainer {
  
  constructor(opt) {
    this.width  = opt.width;
    this.height = opt.height;
    this.hmid = this.height / 2;
    this.ChartTicks = [];
    this.Container = new PIXI.Container();
    this.max = 0;
    this.min = Number.MAX_VALUE;
    this.base = 0;
  }
  
  addChartTick(ct) {
    this.ChartTicks.push(ct);
    this.max = Math.max(this.max, ct.high);
    this.min = Math.min(this.min, ct.low);
    this.setBase();
  }

  setBase() {
    this.base = (this.max + this.min) / 2;
  }

  setMax() {
    this.max = Math.max(...this.ChartTicks.map(m => m.high));
    this.setBase();
  }

  setMin() {
    this.min = Math.min(...this.ChartTicks.map(m => m.low));
    this.setBase();
  }

  setChartPos() {
    let that = this;
    let vx = this.width - 5;
    this.ChartTicks.forEach(function(obj){
      let top = (that.base - obj.high)*100 + that.hmid;
      let height = (that.base - obj.low)*100 + that.hmid - top;
      console.log("top:" + top);
      console.log("height:" + height);
      obj.setPosition({x:vx, y:top, w:2, h:height});
      vx -= obj.width + 2;
    });
  }

  cleanup() {
    //this.Container.destroy(true);
  }

  draw() {
    this.setChartPos();
  }

  setup() {
    let that = this;
    this.ChartTicks.forEach(function(obj){
      let sp = obj.getSprite();
      that.Container.addChild(sp);
    });
    this.draw();
  }

  getContainer() {
    return this.Container;
  }
}

var chartContainer = new ChartContainer({width:255, height:255});
testdata.forEach(function(data){
  chartContainer.addChartTick(new ChartTick(data));
});
//chartContainer.addChartTick(new ChartTick({dt:new Date(),l:5,h:6,s:7,e:8}));
console.log(chartContainer);

PIXI.loader
  .add("img/test.png")
  .load(setup);

function setup() {
  //Create the cat sprite
  let cat = new PIXI.Sprite(PIXI.loader.resources["img/test.png"].texture);

  chartContainer.setup();
  app.stage.addChild(chartContainer.getContainer());

  //Add the cat to the stage
  app.stage.addChild(cat);

}


</script>
</body>
</html>